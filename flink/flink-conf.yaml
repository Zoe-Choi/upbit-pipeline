# ============================================
# Flink Production Configuration
# 실제 서비스 운영을 위한 최적화 설정
# ============================================

# --------------------------------------------
# 1. Checkpointing (장애 복구 필수)
# --------------------------------------------
execution.checkpointing.interval: 60s
execution.checkpointing.mode: EXACTLY_ONCE
execution.checkpointing.timeout: 10min
execution.checkpointing.min-pause: 30s
execution.checkpointing.max-concurrent-checkpoints: 1
execution.checkpointing.externalized-checkpoint-retention: RETAIN_ON_CANCELLATION

# Incremental Checkpoint (RocksDB 사용 시 필수)
state.backend.incremental: true
state.backend.rocksdb.checkpoint.transfer.thread.num: 4

# --------------------------------------------
# 2. Restart Strategy (장애 복구)
# --------------------------------------------
restart-strategy.type: exponential-delay
restart-strategy.exponential-delay.initial-backoff: 1s
restart-strategy.exponential-delay.max-backoff: 60s
restart-strategy.exponential-delay.backoff-multiplier: 2.0
restart-strategy.exponential-delay.reset-backoff-threshold: 1h
restart-strategy.exponential-delay.jitter-factor: 0.1

# --------------------------------------------
# 3. Parallelism (처리량 향상)
# --------------------------------------------
parallelism.default: 2
taskmanager.numberOfTaskSlots: 2

# --------------------------------------------
# 4. Memory Tuning
# --------------------------------------------
jobmanager.memory.process.size: 1024m
taskmanager.memory.process.size: 1728m
taskmanager.memory.managed.fraction: 0.4
state.backend.rocksdb.memory.managed: true

# --------------------------------------------
# 5. Network Buffer (대용량 처리)
# --------------------------------------------
taskmanager.network.memory.fraction: 0.1
taskmanager.network.memory.min: 64mb
taskmanager.network.memory.max: 1gb

# --------------------------------------------
# 6. Kafka Consumer Tuning
# --------------------------------------------
# 파티션 디스커버리 주기 (새 파티션 감지)
# flink.partition-discovery.interval-millis: 60000

# --------------------------------------------
# 7. Metrics (Prometheus 연동)
# --------------------------------------------
metrics.reporter.promgateway.factory.class: org.apache.flink.metrics.prometheus.PrometheusPushGatewayReporterFactory
metrics.reporter.promgateway.hostUrl: http://prometheus-pushgateway:9091
metrics.reporter.promgateway.jobName: flink-upbit-pipeline
metrics.reporter.promgateway.randomJobNameSuffix: true
metrics.reporter.promgateway.deleteOnShutdown: false
metrics.reporter.promgateway.interval: 30s

# --------------------------------------------
# 8. High Availability (HA)
# 프로덕션에서는 Zookeeper/Kubernetes HA 필수
# --------------------------------------------
# high-availability.type: kubernetes
# high-availability.storageDir: s3://paimon/ha

# --------------------------------------------
# 9. Web UI & REST
# --------------------------------------------
web.cancel.enable: true
web.checkpoints.history: 10
web.backpressure.refresh-interval: 10000

# --------------------------------------------
# 10. RocksDB State Backend Tuning
# --------------------------------------------
state.backend.rocksdb.block.cache-size: 64mb
state.backend.rocksdb.writebuffer.size: 64mb
state.backend.rocksdb.thread.num: 4
